<!DOCTYPE html />
<html>
<head>
    <title>BSP web viewer</title>
    <link rel="stylesheet" type="text/css" href="base.css" />
</head>
<body>
    <div id="header">
        <a id="backlink" href="http://tonicodes.net/blog/">back to blog</a>
        <span id="map">map: </span> | 
        <span id="demo">no demo</span> | 
		<span id="fps">fps: </span>
    </div>
    <div id="viewer"></div>

    <script src="jquery.min.js"></script>
    <script src="three.js"></script>
    <script src="FirstPersonControls.js"></script>
    <script src="bsploader.js"></script>
    <script src="pathloader.js"></script>
	<script src="kzhelper.js"></script>
    <script lang="javascript">
        var camera, scene, renderer, controls;
        var clock = new THREE.Clock();
		var showPath = false;
		
		window.addEventListener( 'resize', onWindowResize, false );

		function onWindowResize(){

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );
		}

        (function init() {
            scene = new THREE.Scene();
            //scene.fog = new THREE.Fog(0xc0c0c0, 800, 2000);

            var ambient = new THREE.AmbientLight(0x888888);
            scene.add(ambient);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 10000);
            camera.position.x = 1000;
            camera.position.y = 400;
            camera.position.z = 1000;
            camera.lookAt(new THREE.Vector3(0, 0, 0));
            scene.add(camera);

            controls = new THREE.FirstPersonControls(camera);

            controls.lookSpeed = 0.2;
            controls.movementSpeed = 500;
            controls.noFly = false;
            controls.lookVertical = true;
            controls.verticalMin = 1.5;
            controls.verticalMax = 2.0;

            controls.lon = -110;

            //load_map("nfs_longjump.json");
            //load_path("path.json");
			
            //load_map("kzm_cityhops.json");
            //load_path("kzm_cityhops_Lolz_0312.97.json");

            load_map("risk_forgeblock.json");
			$("#map").text("map: risk_forgeblock.json");
            load_path("risk_forgeblock_kropeq_0408.65.json");
			//$("#demo").text("demo: risk_forgeblock_kropeq_0408.65.json");
			
			$("#togglepath").click(function(e) {
				showPath = !showPath;
				if (showPath)
					scene.add(line);
				else
					scene.remove(line);
			});

            addLine([0, 0, 0], [1000, 0, 0], 0xff0000);
            addLine([0, 0, 0], [0, 1000, 0], 0x00ff00);
            addLine([0, 0, 0], [0, 0, 1000], 0x0000ff);

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);

            $("#viewer").append(renderer.domElement);

            // Report the fps only every second, to only lightly affect measurements
            var fpsOut = document.getElementById('fps');
            setInterval(function () {
                fpsOut.innerHTML = "fps: " + (1000 / frameTime).toFixed(1);
            }, 1000);

            animate();
        }());

        // http://stackoverflow.com/questions/4787431/check-fps-in-js
        // The higher this value, the less the fps will reflect temporary variations
        // A value of 1 will only keep the last value
        var filterStrength = 40;
        var frameTime = 0, lastLoop = new Date, thisLoop;

        function animate() {
            var thisFrameTime = (thisLoop = new Date) - lastLoop;
            frameTime += (thisFrameTime - frameTime) / filterStrength;
            lastLoop = thisLoop;

            // note: three.js includes requestAnimationFrame shim
            requestAnimationFrame(animate);
            render();
        }

        function render() {
            var delta = clock.getDelta();
            if (controls != undefined && controls != null)
                controls.update(delta);

            if (pathFrames != null) {
                // ensure currentTime is in [0, totalLength]
                currentTime = clock.getElapsedTime() * 1000;
                while (currentTime > totalLength)
                    currentTime -= totalLength;

                var newFrame = currentFrame;
                while (newFrame < pathFrames.length) {
                    if (currentTime > pathFrames[newFrame].frameOffset &&
                        currentTime < pathFrames[newFrame].frameOffset + pathFrames[newFrame].length) {
                        break;
                    }

                    newFrame = (newFrame + 1) % pathFrames.length;
                }

                if (newFrame != currentFrame && newFrame < pathFrames.length) {
                    scene.remove(frameLine);
                    frameLine = lineForFrame(currentFrame = newFrame);
                }
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-29035466-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

    </script>
</body>
</html>
